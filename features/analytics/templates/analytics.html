{% extends "base.html" %}

{% block title %}Analytics - Money Matrix{% endblock %}

{% block content %}
<!-- Loading state -->
<div class="loading-container" id="loadingState">
    <div class="loading-spinner"></div>
    <p>Loading analytics...</p>
</div>

<div class="analytics-page" id="analyticsContent" style="display: none;">
    <h1>Financial Analytics</h1>
    
    <div class="analytics-grid">
        <div class="analytics-card glass-effect">
            <h2>Spending Trends</h2>
            <canvas id="trendsChart"></canvas>
        </div>
        
        <div class="analytics-card glass-effect">
            <h2>Category Breakdown</h2>
            <canvas id="categoryChart"></canvas>
        </div>
        
        <div class="analytics-card glass-effect">
            <h2>Income vs Expenses</h2>
            <div id="comparisonStats">
                <div class="stat-item">
                    <span>Total Income:</span>
                    <span class="stat-value income">$0.00</span>
                </div>
                <div class="stat-item">
                    <span>Total Expenses:</span>
                    <span class="stat-value expense">$0.00</span>
                </div>
                <div class="stat-item">
                    <span>Net Savings:</span>
                    <span class="stat-value">$0.00</span>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.analytics-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.analytics-card {
    padding: 2rem;
}

.analytics-card h2 {
    margin-bottom: 1.5rem;
}

.stat-item {
    display: flex;
    justify-content: space-between;
    padding: 1rem 0;
    border-bottom: 1px solid var(--color-border);
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-value {
    font-size: 1.25rem;
    font-weight: 700;
}

.stat-value.income {
    color: var(--color-success);
}

.stat-value.expense {
    color: var(--color-error);
}

.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    gap: 1rem;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script type="module">
import { auth, onAuthStateChanged, isConfigured } from '/static/js/firebase-config.js';

let currentUser = null;
let authInitialized = false;

// Only check auth if Firebase is configured
if (isConfigured && auth) {
    onAuthStateChanged(auth, async (user) => {
        authInitialized = true;
        if (user) {
            currentUser = user;
            // Hide loading, show content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('analyticsContent').style.display = 'block';
            await loadAnalytics();
        } else {
            // Not authenticated - redirect to login
            window.location.replace('/auth/login');
        }
    });
} else {
    // Firebase not configured - demo mode
    console.log('Firebase not configured - running in demo mode');
    checkDemoAccess();
}

// Check if demo access is allowed (development mode)
function checkDemoAccess() {
    const isDemoMode = document.getElementById('analyticsContent') !== null;
    if (isDemoMode) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('analyticsContent').style.display = 'block';
        console.log('Running in demo mode - Firebase not configured');
        if (window.Toast) {
            Toast.info('Demo Mode: Add transactions to see analytics');
        }
    } else {
        window.location.replace('/auth/login');
    }
}

async function loadAnalytics() {
    try {
        const token = await currentUser.getIdToken();
        
        // Load trends
        const trendsResponse = await fetch('/analytics/api/spending-trends', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const trendsData = await trendsResponse.json();
        
        // Load category breakdown
        const categoryResponse = await fetch('/analytics/api/category-breakdown', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const categoryData = await categoryResponse.json();
        
        console.log('Analytics loaded:', { trendsData, categoryData });
        Toast.success('Analytics loaded successfully');
        
    } catch (error) {
        console.error('Error loading analytics:', error);
        Toast.error('Failed to load analytics');
    }
}
</script>
{% endblock %}
