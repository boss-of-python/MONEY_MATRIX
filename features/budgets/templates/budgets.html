{% extends "base.html" %}

{% block title %}Budgets - Money Matrix{% endblock %}

{% block content %}
<!-- Loading state -->
<div class="loading-container" id="loadingState">
    <div class="loading-spinner"></div>
    <p>Loading budgets...</p>
</div>

<div class="budgets-page" id="budgetsContent" style="display: none;">
    <div class="page-header">
        <h1>Budgets</h1>
        <button class="btn btn-primary" id="addBudgetBtn">+ Create Budget</button>
    </div>
    
    <div class="budgets-grid" id="budgetsGrid">
        <!-- Budgets will be loaded here -->
    </div>
</div>

<!-- Budget Modal -->
<div id="budgetModal" class="modal" style="display: none;">
    <div class="modal-content glass-effect">
        <div class="modal-header">
            <h2>Create Budget</h2>
            <button class="modal-close" id="closeModal">&times;</button>
        </div>
        
        <form id="budgetForm">
            <div class="form-group">
                <label for="category">Category *</label>
                <select id="category" class="input" required>
                    <option value="">Select Category</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="limitAmount">Limit Amount *</label>
                <input type="number" id="limitAmount" class="input" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="period">Period *</label>
                <select id="period" class="input" required>
                    <option value="monthly">Monthly</option>
                    <option value="weekly">Weekly</option>
                    <option value="daily">Daily</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="startDate">Start Date *</label>
                <input type="date" id="startDate" class="input" required>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Budget</button>
            </div>
        </form>
    </div>
</div>

<style>
.budgets-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.budgets-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
}

.budget-card {
    padding: 1.5rem;
    background: var(--color-card);
    border-radius: 12px;
}

.budget-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1rem;
}

.budget-amount {
    font-size: 1.5rem;
    font-weight: 700;
}

.progress-bar {
    height: 8px;
    background: var(--color-bg-secondary);
    border-radius: 4px;
    overflow: hidden;
    margin: 1rem 0;
}

.progress-fill {
    height: 100%;
    background: var(--color-primary);
    transition: width 0.3s;
}

.progress-fill.warning {
    background: var(--color-warning);
}

.progress-fill.danger {
    background: var(--color-error);
}

.budget-stats {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    width: 90%;
    max-width: 500px;
    padding: 2rem;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 1.5rem;
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
}

.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    gap: 1rem;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script type="module">
import { auth, onAuthStateChanged, isConfigured } from '/static/js/firebase-config.js';

let currentUser = null;
let authInitialized = false;

// Only check auth if Firebase is configured
if (isConfigured && auth) {
    onAuthStateChanged(auth, async (user) => {
        authInitialized = true;
        if (user) {
            currentUser = user;
            // Hide loading, show content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('budgetsContent').style.display = 'block';
            await loadBudgets();
        } else {
            // Not authenticated - redirect to login
            window.location.replace('/auth/login');
        }
    });
} else {
    // Firebase not configured - demo mode
    console.log('Firebase not configured - running in demo mode');
    checkDemoAccess();
}

// Check if demo access is allowed (development mode)
function checkDemoAccess() {
    const isDemoMode = document.getElementById('budgetsContent') !== null;
    if (isDemoMode) {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('budgetsContent').style.display = 'block';
        document.getElementById('budgetsGrid').innerHTML = '<div class="glass-effect" style="padding: 2rem; text-align: center; grid-column: 1/-1;">Demo Mode: Create budgets to get started</div>';
        console.log('Running in demo mode - Firebase not configured');
        // Load demo categories
        loadDemoCategories();
    } else {
        window.location.replace('/auth/login');
    }
}

// Load demo categories for development mode
function loadDemoCategories() {
    const demoCategories = [
        { id: 1, name: 'Food & Dining' },
        { id: 2, name: 'Transportation' },
        { id: 3, name: 'Shopping' },
        { id: 4, name: 'Entertainment' },
        { id: 5, name: 'Bills & Utilities' },
        { id: 6, name: 'Healthcare' },
        { id: 7, name: 'Travel' },
        { id: 8, name: 'Other' }
    ];
    populateCategories(demoCategories);
}

// Populate category dropdown
function populateCategories(categories) {
    const categorySelect = document.getElementById('category');
    categorySelect.innerHTML = '<option value="">Select Category</option>' + 
        categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
}

async function loadBudgets() {
    try {
        const token = await currentUser.getIdToken();
        
        // Load categories first
        await loadCategories(token);
        
        const response = await fetch('/budgets/api/list', {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const result = await response.json();
        if (result.success) {
            displayBudgets(result.data);
        }
    } catch (error) {
        if (window.Toast) {
            Toast.error('Failed to load budgets');
        }
    }
}

// Load categories from backend
async function loadCategories(token) {
    try {
        // For now, use predefined categories
        // TODO: Replace with actual API call when category management is implemented
        const categories = [
            { id: 1, name: 'Food & Dining' },
            { id: 2, name: 'Transportation' },
            { id: 3, name: 'Shopping' },
            { id: 4, name: 'Entertainment' },
            { id: 5, name: 'Bills & Utilities' },
            { id: 6, name: 'Healthcare' },
            { id: 7, name: 'Travel' },
            { id: 8, name: 'Education' },
            { id: 9, name: 'Personal Care' },
            { id: 10, name: 'Other' }
        ];
        populateCategories(categories);
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

function displayBudgets(budgets) {
    const grid = document.getElementById('budgetsGrid');
    
    if (budgets.length === 0) {
        grid.innerHTML = '<div class="glass-effect" style="grid-column: 1/-1; text-align: center; padding: 2rem; color: var(--color-text-secondary);">No budgets created yet. Click "Create Budget" to get started!</div>';
        return;
    }
    
    grid.innerHTML = budgets.map(b => {
        const categoryName = getCategoryName(b.category_id);
        return `
        <div class="budget-card glass-effect">
            <div class="budget-header">
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">${categoryName}</div>
                    <div class="budget-amount">$${b.limit_amount.toFixed(2)}</div>
                    <div style="color: var(--color-text-secondary); font-size: 0.875rem; text-transform: capitalize;">${b.period}</div>
                </div>
                <button class="btn btn-error btn-sm" onclick="deleteBudget(${b.id})">Delete</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
            <div class="budget-stats">
                <span>Spent: $0.00</span>
                <span>Remaining: $${b.limit_amount.toFixed(2)}</span>
            </div>
            <div style="margin-top: 0.5rem; font-size: 0.75rem; color: var(--color-text-secondary);">
                ${new Date(b.start_date).toLocaleDateString()} - ${new Date(b.end_date).toLocaleDateString()}
            </div>
        </div>
    `;
    }).join('');
}

// Get category name by ID
function getCategoryName(categoryId) {
    const categories = {
        1: 'Food & Dining',
        2: 'Transportation',
        3: 'Shopping',
        4: 'Entertainment',
        5: 'Bills & Utilities',
        6: 'Healthcare',
        7: 'Travel',
        8: 'Education',
        9: 'Personal Care',
        10: 'Other'
    };
    return categories[categoryId] || 'Uncategorized';
}

document.getElementById('addBudgetBtn').addEventListener('click', () => {
    document.getElementById('budgetForm').reset();
    document.getElementById('startDate').valueAsDate = new Date();
    document.getElementById('budgetModal').style.display = 'flex';
});

document.getElementById('closeModal').addEventListener('click', () => {
    document.getElementById('budgetModal').style.display = 'none';
});

document.getElementById('cancelBtn').addEventListener('click', () => {
    document.getElementById('budgetModal').style.display = 'none';
});

document.getElementById('budgetForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const categoryId = document.getElementById('category').value;
    if (!categoryId) {
        if (window.Toast) {
            Toast.error('Please select a category');
        }
        return;
    }
    
    const data = {
        category_id: parseInt(categoryId),
        limit_amount: parseFloat(document.getElementById('limitAmount').value),
        period: document.getElementById('period').value,
        start_date: document.getElementById('startDate').value
    };
    
    try {
        const token = await currentUser.getIdToken();
        const response = await fetch('/budgets/api/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            if (window.Toast) {
                Toast.success(result.message || 'Budget created successfully');
            }
            document.getElementById('budgetModal').style.display = 'none';
            await loadBudgets();
        } else {
            if (window.Toast) {
                Toast.error(result.error || 'Failed to create budget');
            }
        }
    } catch (error) {
        console.error('Error creating budget:', error);
        if (window.Toast) {
            Toast.error('Failed to create budget');
        }
    }
});

window.deleteBudget = async function(id) {
    if (!confirm('Are you sure you want to delete this budget?')) return;
    
    try {
        const token = await currentUser.getIdToken();
        const response = await fetch(`/budgets/api/delete/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const result = await response.json();
        if (result.success) {
            if (window.Toast) {
                Toast.success(result.message || 'Budget deleted successfully');
            }
            await loadBudgets();
        } else {
            if (window.Toast) {
                Toast.error(result.error || 'Failed to delete budget');
            }
        }
    } catch (error) {
        console.error('Error deleting budget:', error);
        if (window.Toast) {
            Toast.error('Failed to delete budget');
        }
    }
};
</script>
{% endblock %}
