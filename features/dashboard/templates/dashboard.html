{% extends "base.html" %}

{% block title %}Dashboard - Money Matrix{% endblock %}

{% block content %}
<!-- Loading state -->
<div class="loading-container" id="loadingState">
    <div class="loading-spinner"></div>
    <p>Loading dashboard...</p>
</div>

<div class="dashboard-page" id="dashboardContent" style="display: none;">
    <div class="dashboard-header">
        <h1 class="dashboard-title">Dashboard</h1>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-secondary" id="syncBtn" title="Sync to Cloud">
                <span id="syncIcon">‚òÅÔ∏è</span> Sync
            </button>
            <button class="btn btn-secondary" id="logoutBtn">Logout</button>
        </div>
    </div>
    
    <div class="dashboard-content">
        <div class="welcome-card glass-effect">
            <h2>Welcome to Money Matrix! üéâ</h2>
            <p>Your personal finance management is ready.</p>
            <p id="userEmail"></p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card glass-effect">
                <div class="stat-icon">üí∞</div>
                <div class="stat-info">
                    <h3>Total Balance</h3>
                    <p class="stat-value">$0.00</p>
                </div>
            </div>
            
            <div class="stat-card glass-effect">
                <div class="stat-icon">üìä</div>
                <div class="stat-info">
                    <h3>This Month</h3>
                    <p class="stat-value">$0.00</p>
                </div>
            </div>
            
            <div class="stat-card glass-effect">
                <div class="stat-icon">üéØ</div>
                <div class="stat-info">
                    <h3>Budget Used</h3>
                    <p class="stat-value">0%</p>
                </div>
            </div>
        </div>
        
        <div class="info-card glass-effect">
            <h3>üöÄ Getting Started</h3>
            <ul>
                <li>Add your first transaction</li>
                <li>Set up budget categories</li>
                <li>Create monthly budgets</li>
                <li>View analytics and insights</li>
            </ul>
        </div>
    </div>
</div>

<style>
.dashboard-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.dashboard-title {
    font-size: 2rem;
    font-weight: 700;
}

.dashboard-content {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.welcome-card {
    padding: 2rem;
    text-align: center;
}

.welcome-card h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.stat-card {
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
}

.stat-icon {
    font-size: 2.5rem;
}

.stat-info h3 {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 700;
}

.info-card {
    padding: 2rem;
}

.info-card h3 {
    margin-bottom: 1rem;
}

.info-card ul {
    list-style: none;
    padding: 0;
}

.info-card li {
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--color-border);
}

.info-card li:last-child {
    border-bottom: none;
}

.info-card li::before {
    content: '\2713 ';
    color: var(--color-success);
    font-weight: bold;
}

.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    gap: 1rem;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script type="module">
import { auth, signOut, onAuthStateChanged, isConfigured } from '/static/js/firebase-config.js';

let currentUser = null;
let authInitialized = false;

// Only check auth if Firebase is configured
if (isConfigured && auth) {
    // Check if user is authenticated
    onAuthStateChanged(auth, async (user) => {
        authInitialized = true;
        if (user) {
            currentUser = user;
            // Hide loading, show dashboard content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('dashboardContent').style.display = 'block';
            document.getElementById('userEmail').textContent = `Logged in as: ${user.email}`;
            await loadDashboardData();
        } else {
            // Not authenticated - redirect to login
            window.location.replace('/auth/login');
        }
    });
} else {
    // Firebase not configured - running in demo mode
    console.log('Firebase not configured - running in demo mode');
    checkDemoAccess();
}

// Check if demo access is allowed (development mode)
function checkDemoAccess() {
    // If the page loaded and we have the dashboard content in DOM,
    // it means backend allowed demo user access
    const isDemoMode = document.getElementById('dashboardContent') !== null;
    
    if (isDemoMode) {
        // Show dashboard with demo data
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('dashboardContent').style.display = 'block';
        document.getElementById('userEmail').textContent = 'Logged in as: demo@example.com (Demo Mode)';
        console.log('Running in demo mode - Firebase not configured');
        // Load demo stats
        loadDemoStats();
    } else {
        // Not authenticated and not demo mode - redirect to login
        window.location.replace('/auth/login');
    }
}

// Load demo statistics for development
function loadDemoStats() {
    document.querySelector('.stat-card:nth-child(1) .stat-value').textContent = '$0.00';
    document.querySelector('.stat-card:nth-child(2) .stat-value').textContent = '$0.00';
    document.querySelector('.stat-card:nth-child(3) .stat-value').textContent = '0%';
}

// Load dashboard data
async function loadDashboardData() {
    try {
        const token = await currentUser.getIdToken();
        const response = await fetch('/dashboard/api/stats', {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            const stats = result.data;
            document.querySelector('.stat-card:nth-child(1) .stat-value').textContent = 
                `$${stats.balance.toFixed(2)}`;
            document.querySelector('.stat-card:nth-child(2) .stat-value').textContent = 
                `$${stats.monthly_expenses.toFixed(2)}`;
            document.querySelector('.stat-card:nth-child(3) .stat-value').textContent = 
                `${stats.budget_used.toFixed(1)}%`;
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// Logout functionality
document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
        if (auth && currentUser) {
            await signOut(auth);
        }
        localStorage.removeItem('auth_token');
        localStorage.removeItem('user_email');
        
        // Call backend logout
        await fetch('/auth/logout', { method: 'POST' });
        
        if (window.Toast) {
            Toast.success('Logged out successfully');
        }
        window.location.href = '/';
    } catch (error) {
        console.error('Logout error:', error);
        if (window.Toast) {
            Toast.error('Logout failed');
        }
    }
});

// Cloud Sync functionality
document.getElementById('syncBtn').addEventListener('click', async () => {
    if (!currentUser) {
        if (window.Toast) {
            Toast.info('Cloud sync is only available for authenticated users');
        }
        return;
    }
    
    try {
        const syncBtn = document.getElementById('syncBtn');
        const syncIcon = document.getElementById('syncIcon');
        
        syncBtn.disabled = true;
        syncIcon.textContent = '‚åõ';
        
        const token = await currentUser.getIdToken();
        const response = await fetch('/sync/api/push', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            if (window.Toast) {
                const stats = result.data.stats;
                Toast.success(`Synced ${stats.transactions} transactions, ${stats.budgets} budgets to cloud`);
            }
            syncIcon.textContent = '‚úîÔ∏è';
            setTimeout(() => {
                syncIcon.textContent = '‚òÅÔ∏è';
            }, 2000);
        } else {
            if (window.Toast) {
                Toast.error(result.error || 'Sync failed');
            }
            syncIcon.textContent = '‚òÅÔ∏è';
        }
    } catch (error) {
        console.error('Sync error:', error);
        if (window.Toast) {
            Toast.error('Failed to sync to cloud');
        }
        document.getElementById('syncIcon').textContent = '‚òÅÔ∏è';
    } finally {
        document.getElementById('syncBtn').disabled = false;
    }
});
</script>
{% endblock %}
