{% extends "base.html" %}

{% block title %}Transactions - Money Matrix{% endblock %}

{% block content %}
<!-- Loading state -->
<div class="loading-container" id="loadingState">
    <div class="loading-spinner"></div>
    <p>Loading transactions...</p>
</div>

<div class="transactions-page" id="transactionsContent" style="display: none;">
    <div class="page-header">
        <h1>Transactions</h1>
        <button class="btn btn-primary" id="addTransactionBtn">+ Add Transaction</button>
    </div>
    
    <div class="filters-section glass-effect">
        <select id="typeFilter" class="input">
            <option value="">All Types</option>
            <option value="income">Income</option>
            <option value="expense">Expense</option>
        </select>
        
        <select id="categoryFilter" class="input">
            <option value="">All Categories</option>
        </select>
    </div>
    
    <div class="transactions-list" id="transactionsList">
        <!-- Transactions will be loaded here -->
    </div>
    
    <div class="pagination" id="pagination"></div>
</div>

<!-- Add/Edit Transaction Modal -->
<div id="transactionModal" class="modal" style="display: none;">
    <div class="modal-content glass-effect">
        <div class="modal-header">
            <h2 id="modalTitle">Add Transaction</h2>
            <button class="modal-close" id="closeModal">&times;</button>
        </div>
        
        <form id="transactionForm">
            <input type="hidden" id="transactionId">
            
            <div class="form-group">
                <label for="amount">Amount *</label>
                <input type="number" id="amount" class="input" step="0.01" required>
            </div>
            
            <div class="form-group">
                <label for="type">Type *</label>
                <select id="type" class="input" required>
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="category">Category</label>
                <select id="category" class="input">
                    <option value="">None</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="date">Date *</label>
                <input type="date" id="date" class="input" required>
            </div>
            
            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" class="input" rows="3"></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">Save</button>
            </div>
        </form>
    </div>
</div>

<style>
.transactions-page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
}

.filters-section {
    padding: 1rem;
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
}

.filters-section select {
    flex: 1;
}

.transactions-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.transaction-item {
    padding: 1.5rem;
    background: var(--color-card);
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: transform 0.2s;
}

.transaction-item:hover {
    transform: translateY(-2px);
}

.transaction-info {
    flex: 1;
}

.transaction-amount {
    font-size: 1.5rem;
    font-weight: 700;
}

.transaction-amount.income {
    color: var(--color-success);
}

.transaction-amount.expense {
    color: var(--color-error);
}

.transaction-description {
    color: var(--color-text-secondary);
    margin-top: 0.25rem;
}

.transaction-date {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
}

.transaction-actions {
    display: flex;
    gap: 0.5rem;
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    width: 90%;
    max-width: 500px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 2rem;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    cursor: pointer;
    color: var(--color-text);
}

.modal-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 1.5rem;
}

.pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
}

.pagination button {
    padding: 0.5rem 1rem;
    border: 1px solid var(--color-border);
    background: var(--color-card);
    cursor: pointer;
    border-radius: 8px;
}

.pagination button.active {
    background: var(--color-primary);
    color: white;
}

.loading-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    gap: 1rem;
}

.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script type="module">
import { auth, onAuthStateChanged, isConfigured } from '/static/js/firebase-config.js';

let currentPage = 1;
let currentUser = null;
let authInitialized = false;

// Only check auth if Firebase is configured
if (isConfigured && auth) {
    // Check authentication
    onAuthStateChanged(auth, async (user) => {
        authInitialized = true;
        if (user) {
            currentUser = user;
            // Hide loading, show content
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('transactionsContent').style.display = 'block';
            await loadTransactions();
        } else {
            // Not authenticated - redirect to login
            window.location.replace('/auth/login');
        }
    });
} else {
    // Firebase not configured - demo mode
    console.log('Firebase not configured - running in demo mode');
    checkDemoAccess();
}

// Check if demo access is allowed (development mode)
function checkDemoAccess() {
    const isDemoMode = document.getElementById('transactionsContent') !== null;
    if (isDemoMode) {
        // Running in demo mode
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('transactionsContent').style.display = 'block';
        document.getElementById('transactionsList').innerHTML = '<div class="glass-effect" style="padding: 2rem; text-align: center;">Demo Mode: Add transactions to get started</div>';
        console.log('Running in demo mode - Firebase not configured');
        // Load categories for demo mode
        loadDemoCategories();
    } else {
        window.location.replace('/auth/login');
    }
}

// Load demo categories
function loadDemoCategories() {
    const categories = [
        { id: 1, name: 'Food & Dining' },
        { id: 2, name: 'Transportation' },
        { id: 3, name: 'Shopping' },
        { id: 4, name: 'Entertainment' },
        { id: 5, name: 'Bills & Utilities' },
        { id: 6, name: 'Healthcare' },
        { id: 7, name: 'Travel' },
        { id: 8, name: 'Education' },
        { id: 9, name: 'Personal Care' },
        { id: 10, name: 'Other' }
    ];
    populateCategories(categories);
}

// Populate category dropdowns
function populateCategories(categories) {
    // Transaction modal category
    const categorySelect = document.getElementById('category');
    categorySelect.innerHTML = '<option value="">None</option>' + 
        categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
    
    // Filter category
    const categoryFilter = document.getElementById('categoryFilter');
    categoryFilter.innerHTML = '<option value="">All Categories</option>' + 
        categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
}

// Load transactions
async function loadTransactions() {
    try {
        // Load categories first if not in demo mode
        if (currentUser) {
            await loadCategories();
        }
        
        const typeFilter = document.getElementById('typeFilter').value;
        const categoryFilter = document.getElementById('categoryFilter').value;
        
        const params = new URLSearchParams({
            page: currentPage,
            per_page: 20
        });
        
        if (typeFilter) params.append('type', typeFilter);
        if (categoryFilter) params.append('category_id', categoryFilter);
        
        const token = await currentUser.getIdToken();
        const response = await fetch(`/transactions/api/list?${params}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            displayTransactions(result.data);
            displayPagination(result.pagination);
        }
    } catch (error) {
        console.error('Error loading transactions:', error);
        if (window.Toast) {
            Toast.error('Failed to load transactions');
        }
    }
}

// Load categories from backend
async function loadCategories() {
    try {
        // For now, use predefined categories
        // TODO: Replace with actual API call when category management is implemented
        const categories = [
            { id: 1, name: 'Food & Dining' },
            { id: 2, name: 'Transportation' },
            { id: 3, name: 'Shopping' },
            { id: 4, name: 'Entertainment' },
            { id: 5, name: 'Bills & Utilities' },
            { id: 6, name: 'Healthcare' },
            { id: 7, name: 'Travel' },
            { id: 8, name: 'Education' },
            { id: 9, name: 'Personal Care' },
            { id: 10, name: 'Other' }
        ];
        populateCategories(categories);
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

// Display transactions
function displayTransactions(transactions) {
    const list = document.getElementById('transactionsList');
    
    if (transactions.length === 0) {
        list.innerHTML = '<div class="glass-effect" style="padding: 2rem; text-align: center;">No transactions found</div>';
        return;
    }
    
    list.innerHTML = transactions.map(t => `
        <div class="transaction-item glass-effect">
            <div class="transaction-info">
                <div class="transaction-amount ${t.type}">
                    ${t.type === 'income' ? '+' : '-'}$${t.amount.toFixed(2)}
                </div>
                <div class="transaction-description">${t.description || 'No description'}</div>
                <div class="transaction-date">${new Date(t.date).toLocaleDateString()}</div>
            </div>
            <div class="transaction-actions">
                <button class="btn btn-secondary" onclick="editTransaction(${t.id})">Edit</button>
                <button class="btn btn-error" onclick="deleteTransaction(${t.id})">Delete</button>
            </div>
        </div>
    `).join('');
}

// Display pagination
function displayPagination(pagination) {
    const paginationDiv = document.getElementById('pagination');
    const buttons = [];
    
    for (let i = 1; i <= pagination.pages; i++) {
        buttons.push(`
            <button class="${i === currentPage ? 'active' : ''}" 
                    onclick="goToPage(${i})">${i}</button>
        `);
    }
    
    paginationDiv.innerHTML = buttons.join('');
}

window.goToPage = function(page) {
    currentPage = page;
    loadTransactions();
};

// Add transaction
document.getElementById('addTransactionBtn').addEventListener('click', () => {
    document.getElementById('modalTitle').textContent = 'Add Transaction';
    document.getElementById('transactionForm').reset();
    document.getElementById('transactionId').value = '';
    document.getElementById('date').valueAsDate = new Date();
    // Ensure categories are loaded
    if (!document.getElementById('category').options.length || document.getElementById('category').options.length === 1) {
        loadDemoCategories();
    }
    document.getElementById('transactionModal').style.display = 'flex';
});

// Close modal
document.getElementById('closeModal').addEventListener('click', () => {
    document.getElementById('transactionModal').style.display = 'none';
});

document.getElementById('cancelBtn').addEventListener('click', () => {
    document.getElementById('transactionModal').style.display = 'none';
});

// Submit transaction
document.getElementById('transactionForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('transactionId').value;
    const data = {
        amount: parseFloat(document.getElementById('amount').value),
        type: document.getElementById('type').value,
        category_id: document.getElementById('category').value || null,
        date: document.getElementById('date').value,
        description: document.getElementById('description').value
    };
    
    try {
        const token = await currentUser.getIdToken();
        const url = id ? `/transactions/api/update/${id}` : '/transactions/api/create';
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            Toast.success(result.message);
            document.getElementById('transactionModal').style.display = 'none';
            await loadTransactions();
        } else {
            Toast.error(result.error);
        }
    } catch (error) {
        console.error('Error saving transaction:', error);
        Toast.error('Failed to save transaction');
    }
});

// Delete transaction
window.deleteTransaction = async function(id) {
    if (!confirm('Are you sure you want to delete this transaction?')) return;
    
    try {
        const token = await currentUser.getIdToken();
        const response = await fetch(`/transactions/api/delete/${id}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            Toast.success(result.message);
            await loadTransactions();
        } else {
            Toast.error(result.error);
        }
    } catch (error) {
        console.error('Error deleting transaction:', error);
        Toast.error('Failed to delete transaction');
    }
};

// Filters
document.getElementById('typeFilter').addEventListener('change', loadTransactions);
document.getElementById('categoryFilter').addEventListener('change', loadTransactions);
</script>
{% endblock %}
